on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v2

      - name: "echo stuff"
        env:
          COMMIT_VAR: ${{ github.event.head_commit.message }}
          COMPOSER_AUTH: '{"github-oauth": {"github.com": "${{ secrets.GH_TOKEN }}"}}'
          COMPOSER_HOME: /tmp/.satis-build
          SATIS_CONFIG: satis.json
          GIT_AUTHOR_NAME: Satis Updater
          GIT_AUTHOR_EMAIL: saits-updater@noreply.github.io
        run: |
          # Extract Package
          if ! [[ $COMMIT_VAR =~ \((.*?)\) ]]; then
            exit 0;
          fi

          PACKAGE=${BASH_REMATCH[1]}

          mkdir /tmp/.satis-build
          echo "{}" > /tmp/.satis-build/composer.json

          composer g require composer/satis:dev-main --prefer-dist \
            --no-cache --no-progress --no-interaction -o \
            --ignore-platform-reqs

          if ! [ -f "${SATIS_CONFIG}" ]; then 
            php $COMPOSER_HOME/vendor/bin/satis init ${SATIS_CONFIG} -n \
              --name="${{ github.repository }}" \
              --homepage="https://github.com/${{ github.repository_owner }}"
          fi
          php $COMPOSER_HOME/vendor/bin/satis add -n --name=${PACKAGE} "https://github.com/${PACKAGE}" ${SATIS_CONFIG} || true
          php $COMPOSER_HOME/vendor/bin/satis build -n ${SATIS_CONFIG} . ${PACKAGE}

          rm -rf include/*
          cp -R build/* .
          rm -rf build/
          git config user.name ${GIT_AUTHOR_NAME}
          git config user.email ${GIT_AUTHOR_EMAIL}
          git add .
          git commit -m "Updated repository"
          git push
        shell: bash
